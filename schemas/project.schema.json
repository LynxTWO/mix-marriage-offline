{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://mix-marriage-offline.dev/schemas/project.schema.json",
  "title": "MMO Project File",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_version", "project_id", "stems_dir", "stems", "settings"],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Project schema version.",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "project_id": {
      "type": "string",
      "minLength": 1
    },
    "name": {
      "type": "string"
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "stems_dir": {
      "type": "string",
      "minLength": 1,
      "description": "Path to the folder containing stems, relative to the project file or absolute."
    },
    "session": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "source_layout_id": {
          "type": "string",
          "pattern": "^LAYOUT\\."
        },
        "sample_rate_hz": {
          "type": "number",
          "minimum": 8000
        },
        "bit_depth": {
          "type": "integer",
          "minimum": 1
        },
        "expected_duration_s": {
          "type": "number",
          "minimum": 0
        }
      }
    },
    "stems": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/stem" }
    },
    "buses": {
      "type": "array",
      "items": { "$ref": "#/$defs/bus" }
    },
    "settings": { "$ref": "#/$defs/settings" },
    "policies": { "$ref": "#/$defs/policies" },
    "plugins": { "$ref": "#/$defs/plugins" },
    "output": { "$ref": "#/$defs/output" }
  },
  "$defs": {
    "stem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stem_id", "file"],
      "properties": {
        "stem_id": { "type": "string", "minLength": 1 },
        "file": { "type": "string", "minLength": 1 },
        "role_id": { "type": "string", "pattern": "^ROLE\\." },
        "is_reference": { "type": "boolean" },
        "layout_id": { "type": "string", "pattern": "^LAYOUT\\." },
        "channel_map": {
          "type": "object",
          "description": "Map from channel index (as string) to SPK.* IDs.",
          "additionalProperties": { "type": "string", "pattern": "^SPK\\." }
        },
        "notes": { "type": "string" }
      }
    },
    "bus": {
      "type": "object",
      "additionalProperties": false,
      "required": ["bus_id", "member_stem_ids"],
      "properties": {
        "bus_id": { "type": "string", "minLength": 1 },
        "member_stem_ids": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        },
        "layout_id": { "type": "string", "pattern": "^LAYOUT\\." }
      }
    },
    "settings": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "intent_profile_id": { "type": "string" },
        "max_risk": { "type": "string", "enum": ["low", "medium", "high"] },
        "allow_mix_bus_actions": { "type": "boolean" },
        "render_enabled": { "type": "boolean" }
      }
    },
    "policies": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "gates_file": { "type": "string" },
        "downmix_registry_file": { "type": "string" },
        "downmix_policy_id": { "type": "string", "pattern": "^POLICY\\.DOWNMIX\\." }
      }
    },
    "plugins": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled_detectors": {
          "type": "array",
          "items": { "type": "string", "pattern": "^PLUGIN\\." },
          "uniqueItems": true
        },
        "enabled_resolvers": {
          "type": "array",
          "items": { "type": "string", "pattern": "^PLUGIN\\." },
          "uniqueItems": true
        },
        "enabled_renderers": {
          "type": "array",
          "items": { "type": "string", "pattern": "^PLUGIN\\." },
          "uniqueItems": true
        },
        "plugin_config": {
          "type": "object",
          "description": "Per-plugin configuration, keyed by plugin_id.",
          "additionalProperties": { "type": "object" }
        }
      }
    },
    "output": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "output_dir": { "type": "string" }
      }
    }
  }
}